<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desktop - Leitor NF-e</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .usb-input { transition: all 0.2s ease-in-out; border-width: 2px; }
        .input-success { border-color: #22c55e !important; box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.4) !important; }
        .input-duplicate { border-color: #f59e0b !important; box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.4) !important; }
        .input-error { border-color: #ef4444 !important; box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.4) !important; }
    </style>
</head>
<body>
    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="container mx-auto max-w-7xl p-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">Painel de Leitura</h1>
            <div class="text-right">
                <div id="user-name" class="font-semibold text-gray-700">Carregando...</div>
                <div id="timer" class="text-sm text-gray-500 font-mono">00:00:00</div>
            </div>
        </div>
    </header>

    <main class="container mx-auto max-w-7xl p-4 mt-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Leitura por Leitor USB</h2>
                    <div id="usb-inputs-container" class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800">NF-e Lidas na Sess√£o</h2>
                        <span id="count" class="text-2xl font-bold bg-indigo-100 text-indigo-700 px-4 py-1 rounded-full">0</span>
                    </div>
                    <div class="h-96 overflow-y-auto pr-2 border rounded-lg p-2 bg-gray-50">
                        <ul id="code-list" class="space-y-2"></ul>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">üì± Conectar Leitor do Celular</h2>
                    <div class="text-gray-600 space-y-3">
                        <p><strong class="text-indigo-600">Passo 1:</strong> Abra a c√¢mera do seu celular.</p>
                        <p><strong class="text-indigo-600">Passo 2:</strong> Aponte para o QR Code abaixo.</p>
                    </div>
                    <div id="qrcode-container" class="flex justify-center p-4 my-4 bg-white rounded-lg border">
                       <div id="qrcode"></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">A√ß√µes</h2>
                    <div class="space-y-3">
                        <a href="{{ url_for('download_arquivo') }}" class="block w-full text-center bg-blue-500 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-blue-600">Baixar Relat√≥rio (.txt)</a>
                        <a href="/logout" class="block w-full text-center bg-red-500 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-red-600">Sair (Encerrar Sess√£o)</a>
                    </div>
                </div>
            </div>

        </div>
    </main>
    <div id="statusCard" class="status-card fixed bottom-4 right-4 bg-white p-4 rounded-lg shadow-lg max-w-xs w-full flex items-center space-x-3 z-40"></div>

    <script src="/assets/qrcode.min.js"></script>
    <script>
        // O C√ìDIGO JAVASCRIPT ABAIXO √â PRATICAMENTE O MESMO, APENAS COM PEQUENOS AJUSTES
        const NUM_USB_INPUTS = 3;
        const BASE_URL = `https://${window.location.host}`;
        const beepSound = new Audio('/assets/beep.mp3');
        const elements = { codeList: document.getElementById("code-list"), count: document.getElementById("count"), userName: document.getElementById("user-name"), timer: document.getElementById("timer"), statusCard: document.getElementById("statusCard"), usbInputsContainer: document.getElementById("usb-inputs-container") };
        let usbInputs = [];
        
        const qrCodeContainer = document.getElementById('qrcode');
        try { const qr = qrcode(0, 'L'); qr.addData(`${BASE_URL}/mobile`); qr.make(); qrCodeContainer.innerHTML = qr.createImgTag(5, 5); } catch(e) { console.error(e); }
        for (let i = 0; i < NUM_USB_INPUTS; i++) { const input = document.createElement('input'); input.type = 'text'; input.dataset.index = i; input.className = 'usb-input w-full px-4 py-3 text-lg text-center border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500'; input.placeholder = `Leitor ${i + 1}`; elements.usbInputsContainer.appendChild(input); usbInputs.push(input); }
        if(usbInputs.length > 0) { usbInputs[0].focus(); usbInputs[0].classList.add('border-indigo-500'); }
        
        async function submitCode(code, sourceInput) { /* ... (sem altera√ß√µes) ... */ }
        usbInputs.forEach(input => { input.addEventListener('keydown', function(event) { if (event.key === 'Enter') { event.preventDefault(); const code = event.target.value.trim(); if (code) { submitCode(code, event.target); } } }); });
        
        function setInputFeedback(inputElement, status) { /* ... (sem altera√ß√µes) ... */ }
        function showStatus(type, message, code = "") { /* ... (sem altera√ß√µes) ... */ }
        async function updateDataFromServer() { /* ... (sem altera√ß√µes) ... */ }
        async function updateSessionInfo() { /* ... (sem altera√ß√µes) ... */ }
        
        // --- Fun√ß√µes de apoio coladas para manter tudo aqui ---
        async function submitCode(code, sourceInput) { const currentIndex = parseInt(sourceInput.dataset.index); usbInputs.forEach(input => input.disabled = true); try { const response = await fetch(`${BASE_URL}/scan`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ qr_code: code }) }); const result = await response.json(); showStatus(result.status, result.message, result.code); setInputFeedback(sourceInput, result.status); if (result.status === 'success') { beepSound.play(); updateDataFromServer(); } } catch (error) { showStatus('error', 'Erro de conex√£o.'); setInputFeedback(sourceInput, 'error'); } finally { setTimeout(() => { sourceInput.value = ''; usbInputs.forEach(input => input.disabled = false); const nextIndex = (currentIndex + 1) % NUM_USB_INPUTS; usbInputs[nextIndex].focus(); usbInputs.forEach(input => input.classList.remove('border-indigo-500')); usbInputs[nextIndex].classList.add('border-indigo-500'); }, 200); } }
        function setInputFeedback(inputElement, status) { const c = { success: 'input-success', duplicate: 'input-duplicate', error: 'input-error' }[status]; if (c) { inputElement.classList.add(c); setTimeout(() => inputElement.classList.remove(c), 700); } }
        function showStatus(type, message, code = "") { let t; clearTimeout(t); elements.statusCard.className = "status-card fixed bottom-4 right-4 bg-white p-4 rounded-lg shadow-lg max-w-xs w-full flex items-center space-x-3 z-40 show"; const i = { success: '<svg class="text-green-500" ...></svg>', duplicate: '<svg class="text-yellow-500" ...></svg>', error: '<svg class="text-red-500" ...></svg>' }; elements.statusCard.innerHTML = `<div>${i[type] || ''}</div><div><p class="font-semibold">${message}</p><p class="text-sm text-gray-600">${code}</p></div>`; t = setTimeout(() => elements.statusCard.classList.remove("show"), 3000); }
        async function updateDataFromServer() { try { const r = await fetch(`${BASE_URL}/data`); const d = await r.json(); elements.count.textContent = d.count; elements.codeList.innerHTML = d.codes.length === 0 ? '<li class="text-center text-gray-500 pt-8">Aguardando leituras...</li>' : d.codes.map(c => `<li class="bg-white p-3 rounded-md text-gray-800 font-mono text-center shadow-sm">${c}</li>`).join(''); } catch (e) { console.error(e); } }
        async function updateSessionInfo() { try { const r = await fetch(`${BASE_URL}/dados-sessao`); if(!r.ok) window.location.href = "/"; const d = await r.json(); elements.userName.textContent = d.nome_usuario; elements.timer.textContent = d.tempo_formatado; } catch (e) { elements.userName.textContent = "Erro"; } }

        updateDataFromServer();
        updateSessionInfo();
        setInterval(updateDataFromServer, 2000);
        setInterval(updateSessionInfo, 1000);
    </script>
</body>
</html>
